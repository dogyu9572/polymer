<?session_start();include_once ($_SERVER['DOCUMENT_ROOT'] . "/common/conf/config.inc.php");include_once ($_SERVER['DOCUMENT_ROOT'] . "/module/board/board.lib.php");include_once ($_SERVER['DOCUMENT_ROOT'] . "/module/category/category.lib.php");include_once $_SERVER['DOCUMENT_ROOT'] . "/module/point/point.lib.php";include_once $_SERVER['DOCUMENT_ROOT'] . "/module/mail/mail.lib.php";include_once $_SERVER['DOCUMENT_ROOT'] . "/module/shop/shop.lib.php";/*use PHPMailer\PHPMailer\PHPMailer;use PHPMailer\PHPMailer\Exception;use PHPMailer\PHPMailer\SMTP;require_once $_SERVER['DOCUMENT_ROOT'] . "/_PHPMailer/src/PHPMailer.php";require_once $_SERVER['DOCUMENT_ROOT'] . "/_PHPMailer/src/Exception.php";require_once $_SERVER['DOCUMENT_ROOT'] . "/_PHPMailer/src/SMTP.php";*///DB연결$dblink = SetConn($_conf_db["main_db"]);$arrBoardInfo = getBoardInfo($_conf_tbl['board_info'], $_REQUEST['boardid']);if($_POST['evnMode']=="write"){	###############################################자동등록방지############################################ //ST	if($_POST['boardid']=="register" || $_POST['boardid']=="help" || ($_POST['boardid']=="qna1" && $_POST['category'] == "2")){		include_once $_SERVER['DOCUMENT_ROOT'] . "/_securimage/securimage.php";		$img = new Securimage();		$valid = $img->check($_POST['code']);		if($valid == true) {		} else {			jsMsg("자동등록방지 입력 오류");			jsHistory("-1") ;			exit;		}	}	###############################################자동등록방지############################################ //ED	if($arrBoardInfo["list"][0]["useadminonly"] =="Y" && !$_SESSION[$_SITE["DOMAIN"]]["ADMIN"]["ID"]){		jsMsg("관리자만 글을 쓸 수 있는 게시판 입니다.");		jsHistory("-1") ;		exit;	}	if(isset($_POST['items']) && is_array($_POST['items'])) {		foreach($_POST['items'] as $item) {			// 기존 POST 데이터 백업			$original_post = $_POST;			// 각 제품의 정보를 POST 데이터로 설정			$_POST['idx'] = $item['idx'];			$_POST['subject'] = $item['subject'];			$_POST['rental_start_date'] = $item['rental_start_date'];			$_POST['rental_end_date'] = $item['rental_end_date'];			$_POST['category1'] = $item['category1'];			$_POST['category2'] = $item['category2'];			$_POST['totalamount'] = $item['totalamount'];			$_POST['usage_day'] = $item['usage_day'];			$discountPercentage = str_replace('%', '', $_POST['discount']) / 100;			$_POST['discountamount'] = $item['totalamount'] * $discountPercentage;			$_POST['finalamount'] = $item['totalamount'] - $_POST['discountamount'];			// 기타 필요한 제품 정보 설정			$writeRS = insertBoardArticle($_POST['boardid'], $arrBoardInfo["list"][0]["thumwidth"]);			if ($writeRS) {				// 장바구니 삭제				$deleteRS = deleteBoardAdmin("equ_applicants_cart", $_POST['idx']);			}			// POST 데이터 복원			$_POST = $original_post;		}	}	else{		$writeRS = insertBoardArticle($_POST['boardid'],$arrBoardInfo["list"][0]["thumwidth"]);	}	if($writeRS){		if($_POST["boardid"] == "accept"){			// 평가접수 등록시			$arrAcceptInfo = getBoardArticleView(mysqli_real_escape_string($dblink,$_POST["boardid"]), "", $writeRS,"info");			$arrEvaluationInfo = getBoardArticleView("evaluation", "", $arrAcceptInfo["list"][0]["homepage"],"info");						$arr_item_name	= explode("|+|",$arrEvaluationInfo['list'][0]['item_name']);	// 산업평가목록			$arr_item_val	= explode("|+|",$arrAcceptInfo['list'][0]['item_val']);			// 접수정보			for($i=0; $i < count($arr_item_name); $i++){				if($arr_item_name[$i]=="상호명"){		$txt_sangho = trim($arr_item_val[$i]);	}				if($arr_item_name[$i]=="대표자명"){		$txt_ceo = trim($arr_item_val[$i]);		}			}			$arrVarData = array(				"#{상호명}"			=> $txt_sangho,				"#{대표자명}"		=> $txt_ceo,				"#{접수번호}"		=> $arrAcceptInfo["list"][0]["r_user"],				"#{평가 산업명}"		=> $arrEvaluationInfo["list"][0]["subject"],				"#{1순위선정발표일}" => $arrEvaluationInfo["list"][0]["publication1_date"],				"#{2순위선정발표일}" => $arrEvaluationInfo["list"][0]["publication2_date"]			);			if($_SITE["SMS_USE"] && $arrAcceptInfo["list"][0]["sms_accept"] == "Y"){ // 문자 전송				smsLmsSureApi("kca_01", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);			}			if($_SITE["ARLIMTALK_USE"] && $arrAcceptInfo["list"][0]["kakao_accept"] == "Y"){ // 카카오 알림톡 전송				kakaoApiTalk("kca_01", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);			}		}		if($_POST['boardid']=="register"){						sendMailRegisterInsert('email1');			jsGo($_POST['returnURL'],"","신청이 완료되었습니다.");		}else{            $arrAcceptInfo = getBoardArticleView(mysqli_real_escape_string($dblink,$_POST["boardid"]), "", $writeRS);            if($arrAcceptInfo["list"][0]["wait_number"] > 0) {                jsGo($_POST['returnURL'], "", "대기번호 " . $arrAcceptInfo["list"][0]["wait_number"] . "번 으로 등록되었습니다.");            } else{                jsGo($_POST['returnURL'],"","등록되었습니다.");            }		}		//	jsGo($_POST['returnURL'],"","Your application is complete.");					}else{		jsMsg("게시물 등록에 실패하였습니다.");		jsHistory("-1") ;	}}else if($_POST['evnMode']=="accept_company_update"){	// 상호 정보 수정	//게시물 수정	$modifyRS = modifyAcceptCompany($_POST['boardid'], $_POST['idx']);	if($modifyRS==true){		jsGo($_POST['returnURL'],"","홈페이지 관리자 승인 후 내 상호 정보가 지역문화 관광정보 페이지에 노출됩니다.");					}else{		jsMsg("등록에 실패하였습니다.");		jsHistory("-1") ;	}}else if($_POST['evnMode']=="cancel"){	//신청 취소    //게시물 수정    $modifyRS = modifyStatusCancel($_POST['boardid'], $_POST['idx'], $_POST['etc_1']);    if($modifyRS==true){        jsGo($_POST['returnURL'],"","취소되었습니다.");    }else{        jsMsg("등록에 실패하였습니다.");        jsHistory("-1") ;    }}else if($_POST['evnMode']=="order_modify"){	// 관리자 결제정보 수정	//게시물 수정	$modifyRS = setOrderAdminSave($_POST['idx']);	if($modifyRS==true){		if($_POST["order_send"] == "Y"){ // sms 전송시						$arrAcceptInfo = getBoardArticleView(mysqli_real_escape_string($dblink,$_POST["boardid"]), "", mysqli_real_escape_string($dblink,$_POST["idx"]),"info");			if($arrAcceptInfo["list"][0]["order_state"] == "3"){ // 등록취소상태일 때만 전송				if($_SITE["SMS_USE"] && $arrAcceptInfo["list"][0]["sms_accept"] == "Y"){ // 문자 전송					smsLmsSureApi("kca_08", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);				}				if($_SITE["ARLIMTALK_USE"] && $arrAcceptInfo["list"][0]["kakao_accept"] == "Y"){ // 카카오 알림톡 전송					kakaoApiTalk("kca_08", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);				}			}else if($arrAcceptInfo["list"][0]["order_state"] == "6"){ // 등록완료상태일 때만 전송				$arrEvaluationInfo = getBoardArticleView("evaluation", "", $arrAcceptInfo["list"][0]["homepage"],"info");				$arrVarData = array(					"#{회신가능기한}" => $arrEvaluationInfo["list"][0]["reply_date"]				);				if($_SITE["SMS_USE"] && $arrAcceptInfo["list"][0]["sms_accept"] == "Y"){ // 문자 전송					smsLmsSureApi("kca_07", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);				}				if($_SITE["ARLIMTALK_USE"] && $arrAcceptInfo["list"][0]["kakao_accept"] == "Y"){ // 카카오 알림톡 전송					kakaoApiTalk("kca_07", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);				}			}		}		jsGo($_POST['returnURL'],"","수정되었습니다.");					}else{		jsMsg("수정에 실패하였습니다.");		//jsHistory("-1") ;	}}else if($_POST['evnMode']=="ship_modify"){	// 관리자 배송정보 수정	//게시물 수정	$modifyRS = setShipAdminSave($_POST['idx']);	if($modifyRS==true){		if($_POST["news_send"] == "Y"){ // 언론보도 전송시						$arrAcceptInfo = getBoardArticleView(mysqli_real_escape_string($dblink,$_POST["boardid"]), "", mysqli_real_escape_string($dblink,$_POST["idx"]),"info");			$arrVarData = array(				"#{기사링크}" => $arrAcceptInfo["list"][0]["ship_link1"]			);			if($_SITE["SMS_USE"] && $arrAcceptInfo["list"][0]["sms_accept"] == "Y"){ // 문자 전송				smsLmsSureApi("kca_09", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);			}			if($_SITE["ARLIMTALK_USE"] && $arrAcceptInfo["list"][0]["kakao_accept"] == "Y"){ // 카카오 알림톡 전송				kakaoApiTalk("kca_09", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);			}		}		if($_POST["online_send"] == "Y"){ // 온라인 발급품 발급시			$arrAcceptInfo = getBoardArticleView(mysqli_real_escape_string($dblink,$_POST["boardid"]), "", mysqli_real_escape_string($dblink,$_POST["idx"]),"info");			$arrVarData = array(				"#{다운로드기한}" => $arrAcceptInfo["list"][0]["ship_link2_show_date"]			);			// 아직 다운로드 기간이 정해지지 않음			if($_SITE["SMS_USE"] && $arrAcceptInfo["list"][0]["sms_accept"] == "Y"){ // 문자 전송				smsLmsSureApi("kca_10", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);			}			if($_SITE["ARLIMTALK_USE"] && $arrAcceptInfo["list"][0]["kakao_accept"] == "Y"){ // 카카오 알림톡 전송				kakaoApiTalk("kca_10", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);			}		}		if($_POST["ship_send"] == "Y"){ // 오프라인 발급품 전송시			$arrAcceptInfo = getBoardArticleView(mysqli_real_escape_string($dblink,$_POST["boardid"]), "", mysqli_real_escape_string($dblink,$_POST["idx"]),"info");			$arrVarData = array(				"#{송장번호}" => $arrAcceptInfo["list"][0]["ship_number"]			);			if($_SITE["SMS_USE"] && $arrAcceptInfo["list"][0]["sms_accept"] == "Y"){ // 문자 전송				smsLmsSureApi("kca_11", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);			}			if($_SITE["ARLIMTALK_USE"] && $arrAcceptInfo["list"][0]["kakao_accept"] == "Y"){ // 카카오 알림톡 전송				kakaoApiTalk("kca_11", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);			}		}		jsGo($_POST['returnURL'],"","수정되었습니다.");					}else{		jsMsg("수정에 실패하였습니다.");		//jsHistory("-1") ;	}}else if($_POST['evnMode']=="reply"){	if($arrBoardInfo["list"][0]["useadminonly"] =="Y" && !$_SESSION[$_SITE["DOMAIN"]]["ADMIN"]["ID"]){		jsMsg("관리자만 글을 쓸 수 있는 게시판 입니다.");		jsHistory("-1") ;		exit;	}	if($_POST['evnMode']=="reply" && $arrBoardInfo["list"][0]["usereply"] !="Y"){		jsMsg("답글쓰기가 제한된 게시판 입니다.");		jsHistory("-1");		exit;	}	//게시물 등록	$replyRS = insertBoardArticleReply($_POST['boardid'], $_POST['idx'], $arrBoardInfo["list"][0]["thumwidth"]);	if($replyRS==true){		jsGo($_POST['returnURL'],"","게시물을 등록하였습니다.");	}else{		jsMsg("게시물 등록에 실패하였습니다.");		jsHistory("-1") ;	}}else if($_POST['evnMode']=="modify"){	if($arrBoardInfo["list"][0]["useadminonly"] =="Y" && !$_SESSION[$_SITE["DOMAIN"]]["ADMIN"]["ID"]){		jsMsg("관리자만 글을 쓸 수 있는 게시판 입니다.");		jsHistory("-1") ;		exit;	}	//게시물 수정	$modifyRS = modifyBoardArticle($_POST['boardid'], $_POST['idx'], $arrBoardInfo["list"][0]["thumwidth"]);	if($_POST['sms_support']=="Y"){	// 광고/후원		sendMailSupport('email4');			}	if($_POST['sms_qna']=="Y"){	// 문의		sendMailQna('email3');	}	if($_POST['sms_register']=="Y"){	// 사전등록 확정		sendMailRegister('email2');			}	if($_POST['mailsend']=="Y"){	#### 답변 메일 발송			$arrInfo = getBoardArticleView($_POST['boardid'], "", $_POST['idx'], "mail");		$arrEtc2List = getCategoryList("2","Y");	// 업종		for($i=0;$i < $arrEtc2List["total"];$i++){			$arrEtc2[$arrEtc2List["list"][$i]["cat_no"]] = $arrEtc2List["list"][$i]["cat_name"];		} 		$arrEtc2["etc"] = "기타/ 해당사항 없음";		$arrInfo["list"][0]["etc_2"] = $arrEtc2[$arrInfo["list"][0]["etc_2"]];			$rs = sendMailQna($arrInfo);		jsGo($_POST['returnURL'],"","발송되었습니다.");	}else{		if($modifyRS==true){			if($_POST["boardid"] == "accept" && $_POST["accept_send"] == "Y"){ // 오프라인 발급품 전송시				$arrAcceptInfo = getBoardArticleView(mysqli_real_escape_string($dblink,$_POST["boardid"]), "", mysqli_real_escape_string($dblink,$_POST["idx"]),"info");				if($_SITE["SMS_USE"] && $arrAcceptInfo["list"][0]["sms_accept"] == "Y"){ // 문자 전송					smsLmsSureApi("kca_02", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);				}				if($_SITE["ARLIMTALK_USE"] && $arrAcceptInfo["list"][0]["kakao_accept"] == "Y"){ // 카카오 알림톡 전송					kakaoApiTalk("kca_02", $arrVarData, $arrAcceptInfo["list"][0]["tel"]);				}			}			if($_POST['altYN']=="Y"){	## 삭제시				jsGo($_POST['returnURL'],"","");			}else{				jsGo($_POST['returnURL'],"","수정되었습니다.");			}						}else{			//jsMsg("게시물 수정에 실패하였습니다.");			jsHistory("-1") ;		}	}}else if($_POST['evnMode']=="delete"){	//게시물 삭제	$deleteRS = deleteBoardArticle($_POST['boardid'], $_POST['idx'], $_POST['pass']);	if($deleteRS==true){		jsGo($_POST['returnURL'],"","게시물을 삭제하였습니다.");	}else{		//jsMsg("게시물 삭제에 실패하였습니다.");		jsHistory("-1") ;	}}else if($_POST['evnMode']=="delete3YearsAgo"){	//게시물 삭제	$deleteRS = deleteBoardArticle3YearsAgo($_POST['boardid']);	if($deleteRS==true){		jsGo($_POST['returnURL'],"","게시물을 삭제하였습니다.");	}else{		jsMsg("게시물 삭제에 실패하였습니다.");		jsHistory("-1") ;	}}elseif($_POST['evnMode']=="unlock"){		$checkRS = unlockBoardArticle($_POST['boardid'], $_POST['idx'], $_POST['pass']);	if($checkRS==true){		//글잠금일경우 세션만들기		$_SESSION[$_SITE['DOMAIN']][($_POST['boardid'])."|".($_POST['idx'])] = TRUE;				jsGo("/community/inquiry.php?boardid=guestqna&mode=view&idx=".$_POST['idx']."&".$_SESSION[$_SITE['DOMAIN']][($_POST['boardid'])."|".($_POST['idx'])],"","");			}else{		jsMsg("비밀번호가 일치하지 않습니다.");		jsHistory("-1") ;	}}else if($_POST['evnMode']=="comment_write"){	$RS = insertComment(mysqli_real_escape_string($GLOBALS['dblink'], $_POST['boardid']), mysqli_real_escape_string($GLOBALS['dblink'], $_POST['board_idx']));	if($RS==true){		jsGo($_POST['returnURL'],"","댓글을 등록 하였습니다.");	}else{		jsMsg("댓글 등록에 실패하였습니다.");		//jsHistory("-1") ;	}}else if($_POST['evnMode']=="comment_modify"){	$RS = updateComment(mysqli_real_escape_string($GLOBALS['dblink'], $_POST['boardid']), mysqli_real_escape_string($GLOBALS['dblink'], $_POST['board_idx']), mysqli_real_escape_string($GLOBALS['dblink'], $_POST['comm_idx']));	if($RS==true){		jsGo($_POST['returnURL'],"","댓글을 수정 하였습니다.");	}else{		jsMsg("댓글 수정에 실패하였습니다.");		jsHistory("-1") ;	}}else if($_POST['evnMode']=="comment_reply"){	$RS = replyComment(mysqli_real_escape_string($GLOBALS['dblink'], $_POST['boardid']), mysqli_real_escape_string($GLOBALS['dblink'], $_POST['board_idx']), mysqli_real_escape_string($GLOBALS['dblink'], $_POST['comm_idx']));	if($RS==true){		jsGo($_POST['returnURL'],"","댓글을 등록 하였습니다.");	}else{		jsMsg("댓글 등록에 실패하였습니다.");		jsHistory("-1") ;	}}else if($_REQUEST['evnMode']=="comment_delete"){	$RS = deleteComment(mysqli_real_escape_string($GLOBALS['dblink'], mysqli_real_escape_string($GLOBALS['dblink'], $_REQUEST[idx])));	if($RS==true){		jsGo($_REQUEST[returnURL],"","댓글을 삭제 하였습니다.");	}else{		jsMsg("댓글 삭제에 실패하였습니다.");		jsHistory("-1") ;	}}//DB해제SetDisConn($dblink);?>